<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
	<title>E-Library — Admin</title>
	<meta charset="UTF-8" />
</h:head>

<ui:composition template="/template/_template.xhtml">

	<ui:define name="head">
		<h:outputStylesheet name="css/admin-dashboard.css" />
		<h:outputStylesheet name="css/client-dashboard.css" />
	</ui:define>

	<ui:define name="button-1">
		<h:form id="logoutForm" styleClass="inline-form" prependId="false">
			<p:commandButton value="Sair" action="#{loginBean.doLogout}"
				icon="pi pi-sign-out" styleClass="btn-logout" ajax="true"
				update="@form" title="Encerrar sessão" />
		</h:form>
	</ui:define>

	<ui:define name="button-2">
		<h:panelGroup rendered="#{sessionBean.loggedUser.rules == 'ADMIN'}">
			<p:button value="Modo Administrador" outcome="/admin/index.html"
				icon="pi pi-user-edit" title="Ir para o modo de administração"
				styleClass="btn-outline" />
		</h:panelGroup>
	</ui:define>

	<ui:define name="title">
		<h1 class="page-title">Painel do Cliente</h1>
	</ui:define>

	<ui:define name="description">
		<p class="user-info">
			Bem-vindo, <strong>#{sessionBean.loggedUser.name}</strong>!
		</p>
	</ui:define>

	<ui:define name="corpo">

		<f:event type="preRenderView" listener="#{dashboardBean.refresh}" />

		<p:growl id="globalMessages" showDetail="true" autoUpdate="true"
			life="3000" />

		<!-- Badge -->
		<h:form id="badgeForm" prependId="false">
			<div class="loans-card">
				<p:commandLink onclick="PF('loansDialog').show(); return false;"
					styleClass="loan-icon-link">
					<i class="pi pi-bookmark" style="font-size: 1.3rem; color: #3a86ff"></i>
				</p:commandLink>

				<h:panelGroup id="badgeContainer" layout="block"
					styleClass="badge-wrapper">
					<span class="badge-circle">#{dashboardBean.activeLoans.size()}</span>
				</h:panelGroup>
			</div>
		</h:form>

		<!-- Summary -->
		<h:panelGroup id="summaryPanel" layout="block"
			styleClass="summary-box">
			<h3>Visão Geral da Biblioteca</h3>
			<div class="description">
				<p>
					Explore os <span>livros disponíveis</span> e clique no ícone
					correspondente para <span>solicitar um empréstimo</span>.
				</p>
				<p>
					Para <span>visualizar seus empréstimos ativos</span>, utilize o
					ícone <span>ao lado</span>.
				</p>
			</div>
			<div class="summary-stats">
				<div class="stat-item">
					<span class="stat-label">Livros cadastrados</span> <span
						class="stat-value">#{dashboardBean.totalBooks}</span>
				</div>
				<div class="stat-item">
					<span class="stat-label">Cópias totais</span> <span
						class="stat-value">#{dashboardBean.totalCopies}</span>
				</div>
				<div class="stat-item">
					<span class="stat-label">Cópias disponíveis</span> <span
						class="stat-value"
						style="color: #{dashboardBean.availableCopies gt 0 ? '#28a745' : '#dc3545'}">
						#{dashboardBean.availableCopies} </span>
				</div>
			</div>
		</h:panelGroup>

		<!-- Filtros -->
		<h:form id="filterForm" prependId="false" styleClass="filter-bar">
			<div class="search-group">
				<span class="ui-input-icon-left"> <i class="pi pi-search" />
					<p:inputText id="searchInput" value="#{dashboardBean.searchQuery}"
						placeholder="Buscar..." styleClass="search-input">
						<p:ajax event="keyup" update=":catalogForm:catalogPanel"
							listener="#{dashboardBean.onSearchChange}" delay="500" />
					</p:inputText>
				</span>
			</div>

			<div class="filter-actions">
				<p:selectBooleanCheckbox id="unavailableOnly"
					value="#{dashboardBean.showOnlyUnavailable}">
					<p:ajax update=":catalogForm:catalogPanel"
						listener="#{dashboardBean.onFilterChange}" />
				</p:selectBooleanCheckbox>

				<p:commandButton value="Todos" action="#{dashboardBean.clearSearch}"
					process="@this"
					update=":filterForm:searchInput :catalogForm:catalogPanel"
					icon="pi pi-book" styleClass="btn-clear" />
			</div>
		</h:form>

		<!-- Catálogo -->
		<h:form id="catalogForm" prependId="false">
			<h:panelGroup id="catalogPanel" layout="block"
				styleClass="catalog-section">

				<p:carousel id="carrossel"
					value="#{dashboardBean.booksWithAvailableCount}" var="row"
					numVisible="3" circular="false" styleClass="book-carousel">

					<h:panelGroup id="wrapper" layout="block" styleClass="product-card">
						<div class="product-content">
							<h3 class="product-title">#{row[0].title}</h3>
							<div class="product-author">
								<i class="pi pi-user"></i> #{row[0].author}
							</div>

							<h:panelGroup id="bookStatsID" styleClass="bookStats"
								layout="block">
								<div class="product-stats">
									<span class="stat-badge total"><i class="pi pi-copy"></i>
										#{row[1]}</span> <span class="stat-badge available"><i
										class="pi pi-check-circle"></i> #{row[2]}</span>
								</div>

								<h:panelGroup rendered="#{row[2] gt 0}">
									<span class="status-badge available"><i
										class="pi pi-check"></i> Disponível</span>
								</h:panelGroup>
								<h:panelGroup rendered="#{row[2] eq 0}">
									<span class="status-badge unavailable"><i
										class="pi pi-times"></i> Indisponível</span>
								</h:panelGroup>
							</h:panelGroup>

							<div class="product-actions">
								<p:commandButton icon="pi pi-info-circle" title="Detalhes"
									styleClass="action-btn details p-button-sm" process="@this"
									update=":detailPanel"
									action="#{dashboardBean.selectBook(row[0], row[1], row[2])}"
									oncomplete="PF('bookDetailDialog').show();" />

								<p:commandButton icon="pi pi-book" title="Emprestar"
									styleClass="action-btn borrow p-button-sm" process="@this"
									update=":summaryPanel :loansDialogContent :badgeForm:badgeContainer :globalMessages :catalogForm:catalogPanel"
									oncomplete="PF('borrowSuccessDialog').show()"
									action="#{dashboardBean.borrow(row[0])}" />
							</div>
						</div>
					</h:panelGroup>

				</p:carousel>
			</h:panelGroup>
		</h:form>

		<!-- Dialog Detalhes -->
		<p:dialog widgetVar="bookDetailDialog" header="Detalhes do Livro"
			modal="true" width="500" resizable="false" appendTo="@(body)">
			<h:panelGroup id="detailPanel">
				<div class="book-detail-container">
					<div class="detail-row">
						<span class="detail-label">Título:</span>
						#{dashboardBean.selectedBook.title}
					</div>
					<div class="detail-row">
						<span class="detail-label">ISBN:</span>
						#{dashboardBean.selectedBook.isbn}
					</div>
					<div class="detail-row">
						<span class="detail-label">Autor:</span>
						#{dashboardBean.selectedBook.author}
					</div>
					<div class="detail-row">
						<span class="detail-label">Editora:</span>
						#{dashboardBean.selectedBook.publisher}
					</div>
					<div class="detail-row">
						<span class="detail-label">Ano:</span>
						#{dashboardBean.selectedBook.year}
					</div>
					<div class="detail-row">
						<span class="detail-label">Total:</span>
						#{dashboardBean.detailTotal}
					</div>
					<div class="detail-row">
						<span class="detail-label">Disponíveis:</span>
						#{dashboardBean.detailAvailable}
					</div>
				</div>
			</h:panelGroup>
			<f:facet name="footer">
				<p:commandButton value="Fechar" type="button"
					onclick="PF('bookDetailDialog').hide();" />
			</f:facet>
		</p:dialog>

		<!-- Dialog Empréstimos -->
		<p:dialog widgetVar="loansDialog" header="Meus Empréstimos"
			modal="true" width="800" appendTo="@(body)">

			<h:panelGroup id="loansDialogContent">
			
				<p:dataTable value="#{dashboardBean.activeLoans}" var="loan"
					emptyMessage="Nenhum empréstimo ativo.">
					
					<p:column headerText="Livro">
						<h:outputText value="#{loan.bookTitle}" />
					</p:column>
					
					<p:column headerText="Data">
						<h:outputText value="#{loan.borrowDate}" />
					</p:column>
					
					<p:column headerText="Prazo">
						<h:outputText value="#{loan.daysRemaining} dias" />
					</p:column>
					
					<p:column headerText="Ações" width="15%"
						style="text-align: center;">
						<p:commandButton icon="pi pi-undo" title="Devolver"
							action="#{dashboardBean.returnCopy(loan)}"
							update=":summaryPanel :catalogPanel :loansDialogContent :badgeForm:badgeContainer :globalMessages"
							process="@this"
							styleClass="p-button-sm p-button-warning return-book" />
					</p:column>
				</p:dataTable>
			</h:panelGroup>
			<f:facet name="footer">
				<p:commandButton value="Fechar" type="button"
					onclick="PF('loansDialog').hide();" />
			</f:facet>
		</p:dialog>

		<!-- Dialog Sucesso -->
		<h:form id="dialogsForm" prependId="false">
			<p:dialog widgetVar="borrowSuccessDialog"
				header="Empréstimo Confirmado!" modal="true" width="600"
				appendTo="@(body)">
				<div class="borrow-success-content">
					<i class="pi pi-check-circle success-icon"></i>
					<p>
			            Aproveite sua leitura.<br />
			            Para ver seus empréstimos ativos, clique no <strong>ícone <i class="pi pi-bookmark"></i> ao lado do título</strong>.
			        </p>
				</div>
				<f:facet name="footer">
					<p:commandButton value="Ok" type="button"
						onclick="PF('borrowSuccessDialog').hide();" />
				</f:facet>
			</p:dialog>
		</h:form>

	</ui:define>

</ui:composition>
</html>